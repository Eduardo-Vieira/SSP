<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext 
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<changeSet author='daniel.bower' id='Implement ChallengeCategory'>
		<dropColumn tableName="challenge_category" columnName="name" />
		<dropColumn tableName="challenge_category" columnName="description" />
		
		<addColumn tableName="challenge_category">
			<column name="challenge_id" type="uuid">
				<constraints nullable="false"
					foreignKeyName="challenge_category_challenge_id_challenge_id"
					references="challenge(id)" />
			</column>
			<column name="category_id" type="uuid">
				<constraints nullable="false"
					foreignKeyName="challenge_category_category_id_category_id"
					references="category(id)" />
			</column>
		</addColumn>

		<rollback>
			<addColumn tableName="challenge_category">
				<column name="name" type="character varying(80)" value="default">
					<constraints nullable="false" />
				</column>
				<column name="description" type="text">
					<constraints nullable="true" />
				</column>
			</addColumn>
			<dropColumn tableName="challenge_category" columnName="challenge_id"/>
			<dropColumn tableName="challenge_category" columnName="category_id"/>
		</rollback>
	</changeSet>
	
	<changeSet author="daniel.bower" id="add person to goal">
		<addColumn tableName="goal">
			<column name="person_id" type="uuid">
				<constraints nullable="false"
					foreignKeyName="goal_person_id_person_id" 
					references="person(id)" />
			</column>
		</addColumn>
		
		<rollback>
			<dropColumn tableName="goal" columnName="person_id"/>
		</rollback>
	</changeSet>
	
	<changeSet author='daniel.bower' id='Add special_service_group table'>
		<createTable tableName="special_service_group">
			<column name="id" type="uuid">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying(80)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="text">
				<constraints nullable="true" />
			</column>
			<column name="created_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="modified_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="created_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="special_service_group_created_by_person_id"
					references="person(id)" />
			</column>
			<column name="modified_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="special_service_group_modified_by_person_id"
					references="person(id)" />
			</column>
			<column name="object_status" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>

		<sql>grant all on special_service_group to ssp</sql>
		<rollback>
			<dropTable tableName="special_service_group" />
		</rollback>

		<!-- Theres a different assumption in the liquibase handling of timezones 
			on postgres. Specifying "Without" timezone -->
		<modifySql dbms="postgresql">
			<replace replace="WITH TIME ZONE" with="WITHOUT TIME ZONE" />
		</modifySql>

	</changeSet>

	<changeSet author='daniel.bower' id='Add service_reason table'>
		<createTable tableName="service_reason">
			<column name="id" type="uuid">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying(80)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="text">
				<constraints nullable="true" />
			</column>
			<column name="created_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="modified_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="created_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="service_reason_created_by_person_id" references="person(id)" />
			</column>
			<column name="modified_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="service_reason_modified_by_person_id" references="person(id)" />
			</column>
			<column name="object_status" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>

		<sql>grant all on service_reason to ssp</sql>
		<rollback>
			<dropTable tableName="service_reason" />
		</rollback>

		<!-- Theres a different assumption in the liquibase handling of timezones 
			on postgres. Specifying "Without" timezone -->
		<modifySql dbms="postgresql">
			<replace replace="WITH TIME ZONE" with="WITHOUT TIME ZONE" />
		</modifySql>

	</changeSet>

	<changeSet author='daniel.bower' id='Add referral_source table'>
		<createTable tableName="referral_source">
			<column name="id" type="uuid">
				<constraints primaryKey="true" nullable="false" />
			</column>
			<column name="name" type="character varying(80)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="text">
				<constraints nullable="true" />
			</column>
			<column name="created_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="modified_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="created_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="referral_source_created_by_person_id" references="person(id)" />
			</column>
			<column name="modified_by" type="uuid">
				<constraints nullable="false"
					foreignKeyName="referral_source_modified_by_person_id" references="person(id)" />
			</column>
			<column name="object_status" type="int">
				<constraints nullable="false" />
			</column>
		</createTable>

		<sql>grant all on referral_source to ssp</sql>
		<rollback>
			<dropTable tableName="referral_source" />
		</rollback>

		<!-- Theres a different assumption in the liquibase handling of timezones 
			on postgres. Specifying "Without" timezone -->
		<modifySql dbms="postgresql">
			<replace replace="WITH TIME ZONE" with="WITHOUT TIME ZONE" />
		</modifySql>

	</changeSet>
</databaseChangeLog>